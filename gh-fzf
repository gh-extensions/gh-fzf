#!/bin/bash

source_dir=$(dirname "${BASH_SOURCE[0]}")

gh_pr_list() {
	# Set up columns and template
	local pr_columns="number,title,state,headRefName,milestone,updatedAt,labels,additions,deletions,changedFiles,isDraft"
	local pr_template
	local pr_list

	pr_template=$(cat "$source_dir/templates/gh_pr_list")

	# Query GitHub for pull requests with spinner feedback
	pr_list=$(gum spin --title "Loading GitHub Pull Requests..." -- \
		gh pr list --json "$pr_columns" --template "$pr_template" --limit 30)

	# Check if we got any pull requests
	if [ -z "$pr_list" ]; then
		gum log --level=warn "No GitHub Pull Requests found. Make sure you're in a GitHub repository and have pull requests available."
		return 1
	fi

	# Transform and present in fzf
	echo "$pr_list" | fzf --ansi \
		--with-nth=1.. \
		--accept-nth=1 \
		--header="  GitHub Pull Requests" \
		--header-lines=1 \
		--color=header:blue \
		--bind 'enter:execute(gh pr view {1})+abort' \
		--bind 'ctrl-o:execute(gh pr view {1} --web)+abort' \
		--bind 'ctrl-w:execute(gh pr checks {1} --web)+abort' \
		--bind 'alt-c:execute(gh pr comment {1} --editor)+abort' \
		--bind 'alt-e:execute(gh pr edit {1})+abort' \
		--bind 'alt-x:execute(gh pr close {1})+abort' \
		--bind 'alt-r:execute(gh pr reopen {1})+abort' \
		--bind 'alt-m:execute(gh pr merge -r -d {1})+abort' \
		--bind 'alt-y:execute(gh pr review {1} --approve -c "LGTM")+abort' \
		--bind 'alt-w:execute(gh pr checks {1} --watch)+abort'
}

gh_run_list() {
	# Set up columns and template
	local run_columns="updatedAt,event,displayTitle,headBranch,databaseId,conclusion,status,name"
	local run_template
	local run_list

	run_template=$(cat "$source_dir/templates/gh_run_list")

	# Query GitHub for workflow runs with spinner feedback
	run_list=$(gum spin --title "Loading GitHub Runs..." -- \
		gh run list --json "$run_columns" --template "$run_template" --limit 30)

	# Check if we got any runs
	if [ -z "$run_list" ]; then
		gum log --level=warn "No GitHub Runs found. Make sure you're in a GitHub repository and have workflow runs available."
		return 1
	fi

	# Transform and present in fzf
	echo "$run_list" | fzf --ansi \
		--with-nth=1.. \
		--accept-nth=-1 \
		--header="  GitHub Runs" \
		--header-lines=1 \
		--color=header:blue \
		--bind 'enter:execute(gh run view {-1})+abort' \
		--bind 'ctrl-o:execute(gh run view {-1} --web)+abort' \
		--bind 'ctrl-w:execute(gh run view {-1} --web)+abort' \
		--bind 'alt-x:execute(gh run cancel {-1})+abort' \
		--bind 'alt-r:execute(gh run rerun {-1})+abort' \
		--bind 'alt-l:execute(gh run view --log {-1})+abort' \
		--bind 'alt-d:execute(gh run download {-1})+abort' \
		--bind 'alt-w:execute(gh run watch {-1})+abort'
}

gh_issue_list() {
	# Set up columns and template
	local issue_columns="number,title,author,assignees,state,milestone,labels,updatedAt"
	local issue_template
	local issue_list

	issue_template=$(cat "$source_dir/templates/gh_issue_list")

	# Query GitHub for issues with spinner feedback
	issue_list=$(gum spin --title "Loading GitHub Issues..." -- \
		gh issue list --json "$issue_columns" --template "$issue_template" --limit 30)

	# Check if we got any issues
	if [ -z "$issue_list" ]; then
		gum log --level=warn "No GitHub Issues found. Make sure you're in a GitHub repository and have issues available."
		return 1
	fi

	# Transform and present in fzf
	echo "$issue_list" | fzf --ansi \
		--with-nth=1.. \
		--accept-nth=1 \
		--header="  GitHub Issues" \
		--header-lines=1 \
		--color=header:blue \
		--bind 'enter:execute(gh issue view {1})+abort' \
		--bind 'ctrl-o:execute(gh issue view {1} --web)+abort' \
		--bind 'alt-c:execute(gh issue comment {1} --editor)+abort' \
		--bind 'alt-e:execute(gh issue edit {1})+abort' \
		--bind 'alt-x:execute(gh issue close {1})+abort' \
		--bind 'alt-r:execute(gh issue reopen {1})+abort' \
		--bind 'alt-a:execute(gh issue edit {1} --add-assignee @me)+abort' \
		--bind 'alt-l:execute(gh issue edit {1} --add-label)+abort' \
		--bind 'alt-p:execute(gh issue pin {1})+abort' \
		--bind 'alt-u:execute(gh issue unpin {1})+abort'
}

_show_root_help() {
	cat <<'EOF'
gh-fzf - Interactive fuzzy finder for GitHub CLI

USAGE:
    gh-fzf <command>

COMMANDS:
    pr          Browse and interact with GitHub pull requests
    run         Browse and interact with GitHub workflow runs
    issue       Browse and interact with GitHub issues

EXAMPLES:
    gh-fzf pr                           # Browse pull requests interactively
    gh-fzf run                          # Browse workflow runs interactively
    gh-fzf issue                        # Browse issues interactively
EOF
}

main() {
	local command="$1"

	case $command in
	pr)
		gh_pr_list
		;;
	run)
		gh_run_list
		;;
	issue)
		gh_issue_list
		;;
	--help | -h | help | "")
		_show_root_help
		;;
	*)
		gum log --level=error "Unknown command '$command'"
		gum log --level=info "Available commands: pr, run, issue"
		gum log --level=info "Run 'gh fzf --help' for detailed usage information"
		exit 1
		;;
	esac
}

main "$@"
