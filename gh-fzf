#!/usr/bin/env bash

[ -z "$DEBUG" ] || set -x

set -eo pipefail

_gh_fzf_source_dir=$(dirname "${BASH_SOURCE[0]}")

# Source command implementations
source "$_gh_fzf_source_dir/scripts/gh_pr.sh"
source "$_gh_fzf_source_dir/scripts/gh_issue.sh"
source "$_gh_fzf_source_dir/scripts/gh_run.sh"
source "$_gh_fzf_source_dir/scripts/gh_repo.sh"
source "$_gh_fzf_source_dir/scripts/gh_search.sh"
# _show_root_help()
#
# Display help information for gh-fzf
#
# DESCRIPTION:
#   Prints the main help documentation for the gh-fzf tool, including
#   usage instructions, available commands, and examples. This function
#   is called when the user requests help or runs gh-fzf without arguments.
#
# PARAMETERS:
#   None
#
# RETURNS:
#   0 - Always returns success
#
# OUTPUT:
#   Writes help text to stdout including:
#   - Tool description
#   - Usage syntax
#   - Available commands (pr, run, issue)
#   - Example usage for each command
#
# DEPENDENCIES:
#   None
#
# EXAMPLE:
#   gh-fzf --help
#   gh-fzf -h
#   gh-fzf help
#   gh-fzf        # (no arguments)
#
_show_root_help() {
	cat <<'EOF'
gh-fzf - Interactive fuzzy finder for GitHub CLI

USAGE:
    gh-fzf [fzf-flags] <command> [command-flags]

FZF FLAGS (specify before command):
    Any fzf flags can be passed before the command. These are passed directly
    to fzf. Common examples:

    --tmux [position]         Open in tmux popup (default: center,50%,50%)
                              Position format: [position][,width[,height]]
                              Examples: "80%,80%", "center,50%,50%", "bottom"
    --height <n>              Set height (e.g., --height 50%)
    --border <style>          Set border style (e.g., --border rounded)
    --preview-window <opts>   Configure preview window
    --reverse                 Reverse layout

    See 'man fzf' for all available fzf options.

COMMANDS:
    pr          Browse and interact with GitHub pull requests
    run         Browse and interact with GitHub workflow runs
    issue       Browse and interact with GitHub issues
    repo        Browse and interact with GitHub repositories
    search      Search across GitHub (repos, issues, prs)

COMMAND FLAGS (specify after command):
    Most flags are passed through to the underlying gh command (gh pr list,
    gh issue list, gh run list). Common useful flags include:

    --state <state>           Filter by state (open, closed, merged, all)
    --author <user>           Filter by author
    --assignee <user>         Filter by assignee
    --label <label>           Filter by label
    --search <query>          Search with query
    --limit <n>               Number of results to show (default: 30)
    --branch <branch>         Filter by branch (for runs)
    --status <status>         Filter by status (for runs)
    --workflow <name>         Filter by workflow name (for runs)

    Reserved flags (controlled by gh-fzf, cannot be overridden):
    --json, --jq, -q          Output format (gh-fzf manages this)
    --template, -t            Output template (gh-fzf manages this)

EXAMPLES:
    # Basic usage
    gh-fzf pr                           # Browse pull requests interactively
    gh-fzf pr --state closed            # Browse closed pull requests
    gh-fzf pr --author @me --state all  # Browse all your PRs
    gh-fzf pr --label bug --limit 50    # Browse bug-labeled PRs (show 50)
    gh-fzf pr --search "memory leak"    # Search PRs for "memory leak"

    gh-fzf issue                        # Browse issues interactively
    gh-fzf issue --state closed         # Browse closed issues
    gh-fzf issue --assignee @me         # Browse issues assigned to you
    gh-fzf issue --label "help wanted"  # Browse issues with label

    gh-fzf run                          # Browse workflow runs interactively
    gh-fzf run --status success         # Browse successful runs
    gh-fzf run --branch main --limit 50 # Browse main branch runs (show 50)
    gh-fzf run --workflow "CI"          # Browse CI workflow runs

    gh-fzf repo                         # Browse your repositories
    gh-fzf repo octocat                 # Browse octocat's repositories
    gh-fzf repo --language Go           # Browse Go repositories
    gh-fzf repo octocat --limit 50      # Browse octocat's repos (show 50)

    gh-fzf search repos                 # Interactive repository search
    gh-fzf search issues "bug"          # Search issues (with initial query)
    gh-fzf search prs "fix"             # Search pull requests

    # With fzf flags (tmux popup)
    gh-fzf --tmux pr                    # Open PRs in tmux popup (default size)
    gh-fzf --tmux "80%,80%" pr          # Open PRs in tmux popup (80% size)
    gh-fzf --tmux center,50% issue      # Center popup, 50% size
    gh-fzf --tmux bottom search repos   # Bottom popup for search

    # With other fzf flags
    gh-fzf --height 20 --border rounded pr          # Custom height and border
    gh-fzf --reverse --height 100% issue            # Reverse layout, full height
    gh-fzf --preview-window right:50% run           # Custom preview window
EOF
}

# main()
#
# Main entry point for gh-fzf
#
# DESCRIPTION:
#   Processes command line arguments including global flags, and dispatches to
#   appropriate sub-commands. Handles global --tmux flag for opening fzf in tmux
#   popups, as well as command routing for pr, run, issue, repo, and search commands.
#
# GLOBAL FLAGS (before command):
#   --tmux <position>  - Open fzf in tmux popup with specified position
#
# PARAMETERS:
#   $@ - Global flags, command, and command-specific flags
#        Example: --tmux "80%,80%" pr --state closed
#
# RETURNS:
#   0   - Success (command executed successfully)
#   1   - Error (unknown command or missing --tmux value)
#   Exit code from sub-command if applicable
#
# COMMANDS:
#   pr      - Launch interactive PR browser
#   run     - Launch interactive workflow run browser
#   issue   - Launch interactive issue browser
#   repo    - Launch interactive repository browser
#   search  - Launch interactive search (repos, issues, prs)
#   help    - Show help information
#   --help  - Show help information
#   -h      - Show help information
#   (empty) - Show help information
#
# ERROR HANDLING:
#   - Unknown commands trigger an error message with available commands
#   - Missing --tmux value triggers an error
#   - Suggests running 'gh fzf --help' for detailed usage
#
# DEPENDENCIES:
#   - gum (for error logging)
#   - Sub-command functions (_gh_pr_list, _gh_run_list, _gh_issue_list, _gh_repo_list, _gh_search_list)
#
# EXAMPLE:
#   main "pr"                          # Launch PR browser
#   main "--tmux" "80%,80%" "pr"       # Launch PR browser in tmux popup
#   main "--tmux=center" "issue"       # Launch issue browser in centered tmux popup
#   main "help"                        # Show help
#
main() {
	local fzf_flags=()
	local command=""
	local command_args=()

	# Parse arguments: everything before command = fzf flags, everything after = command args
	while [[ $# -gt 0 ]]; do
		case "$1" in
		--help | -h | help)
			_show_root_help
			exit 0
			;;
		pr | run | issue | repo | search)
			# Found the command, everything after this is command args
			command="$1"
			shift
			command_args=("$@")
			break
			;;
		*)
			# Before command, collect as fzf flags
			fzf_flags+=("$1")
			shift
			;;
		esac
	done

	# Export fzf flags for gh_core.sh to use
	if [[ ${#fzf_flags[@]} -gt 0 ]]; then
		# Use printf %q to properly quote each element for safe eval
		export GH_FZF_FLAGS="$(printf '%q ' "${fzf_flags[@]}")"
	fi

	# Dispatch to command with remaining args
	case $command in
	pr)
		_gh_pr_list "${command_args[@]}"
		;;
	run)
		_gh_run_list "${command_args[@]}"
		;;
	issue)
		_gh_issue_list "${command_args[@]}"
		;;
	repo)
		_gh_repo_list "${command_args[@]}"
		;;
	search)
		_gh_search_list "${command_args[@]}"
		;;
	"")
		_show_root_help
		;;
	*)
		gum log --level error "Unknown command '$command'"
		gum log --level info "Available commands: pr, run, issue, repo, search"
		gum log --level info "Run 'gh fzf --help' for detailed usage information"
		exit 1
		;;
	esac
}

main "$@"
