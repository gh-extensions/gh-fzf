#!/usr/bin/env bash

[ -z "$DEBUG" ] || set -x

set -eo pipefail

_gh_fzf_source_dir=$(dirname "${BASH_SOURCE[0]}")

# Source command implementations
source "$_gh_fzf_source_dir/scripts/gh_pr.sh"
source "$_gh_fzf_source_dir/scripts/gh_issue.sh"
source "$_gh_fzf_source_dir/scripts/gh_run.sh"
source "$_gh_fzf_source_dir/scripts/gh_repo.sh"
# _show_root_help()
#
# Display help information for gh-fzf
#
# DESCRIPTION:
#   Prints the main help documentation for the gh-fzf tool, including
#   usage instructions, available commands, and examples. This function
#   is called when the user requests help or runs gh-fzf without arguments.
#
# PARAMETERS:
#   None
#
# RETURNS:
#   0 - Always returns success
#
# OUTPUT:
#   Writes help text to stdout including:
#   - Tool description
#   - Usage syntax
#   - Available commands (pr, run, issue)
#   - Example usage for each command
#
# DEPENDENCIES:
#   None
#
# EXAMPLE:
#   gh-fzf --help
#   gh-fzf -h
#   gh-fzf help
#   gh-fzf        # (no arguments)
#
_show_root_help() {
	cat <<'EOF'
gh-fzf - Interactive fuzzy finder for GitHub CLI

USAGE:
    gh-fzf <command> [flags]

COMMANDS:
    pr          Browse and interact with GitHub pull requests
    run         Browse and interact with GitHub workflow runs
    issue       Browse and interact with GitHub issues
    repo        Browse and interact with GitHub repositories

FLAGS:
    Most flags are passed through to the underlying gh command (gh pr list,
    gh issue list, gh run list). Common useful flags include:

    --state <state>           Filter by state (open, closed, merged, all)
    --author <user>           Filter by author
    --assignee <user>         Filter by assignee
    --label <label>           Filter by label
    --search <query>          Search with query
    --limit <n>               Number of results to show (default: 30)
    --branch <branch>         Filter by branch (for runs)
    --status <status>         Filter by status (for runs)
    --workflow <name>         Filter by workflow name (for runs)

    Reserved flags (controlled by gh-fzf, cannot be overridden):
    --json, --jq, -q          Output format (gh-fzf manages this)
    --template, -t            Output template (gh-fzf manages this)

EXAMPLES:
    gh-fzf pr                           # Browse pull requests interactively
    gh-fzf pr --state closed            # Browse closed pull requests
    gh-fzf pr --author @me --state all  # Browse all your PRs
    gh-fzf pr --label bug --limit 50    # Browse bug-labeled PRs (show 50)
    gh-fzf pr --search "memory leak"    # Search PRs for "memory leak"

    gh-fzf issue                        # Browse issues interactively
    gh-fzf issue --state closed         # Browse closed issues
    gh-fzf issue --assignee @me         # Browse issues assigned to you
    gh-fzf issue --label "help wanted"  # Browse issues with label

    gh-fzf run                          # Browse workflow runs interactively
    gh-fzf run --status success         # Browse successful runs
    gh-fzf run --branch main --limit 50 # Browse main branch runs (show 50)
    gh-fzf run --workflow "CI"          # Browse CI workflow runs

    gh-fzf repo                         # Browse your repositories
    gh-fzf repo octocat                 # Browse octocat's repositories
    gh-fzf repo --language Go           # Browse Go repositories
    gh-fzf repo octocat --limit 50      # Browse octocat's repos (show 50)
EOF
}

# main()
#
# Main entry point for gh-fzf
#
# DESCRIPTION:
#   Processes command line arguments and dispatches to appropriate sub-commands.
#   Handles command routing for pr, run, and issue commands, as well as help
#   requests and error cases. This function serves as the central dispatcher
#   for all gh-fzf functionality.
#
# PARAMETERS:
#   $1 - Command to execute (pr|run|issue|help|--help|-h)
#        Optional - if omitted, shows help
#
# RETURNS:
#   0   - Success (command executed successfully)
#   1   - Error (unknown command)
#   Exit code from sub-command if applicable
#
# COMMANDS:
#   pr      - Launch interactive PR browser
#   run     - Launch interactive workflow run browser
#   issue   - Launch interactive issue browser
#   help    - Show help information
#   --help  - Show help information
#   -h      - Show help information
#   (empty) - Show help information
#
# ERROR HANDLING:
#   - Unknown commands trigger an error message with available commands
#   - Suggests running 'gh fzf --help' for detailed usage
#
# DEPENDENCIES:
#   - gum (for error logging)
#   - Sub-command functions (_gh_pr_list, _gh_run_list, _gh_issue_list, _gh_repo_list)
#
# EXAMPLE:
#   main "pr"     # Launch PR browser
#   main "help"   # Show help
#   main "foo"    # Error: unknown command
#
main() {
	local command="$1"
	shift # Remove command from arguments, leaving optional flags

	case $command in
	pr)
		_gh_pr_list "$@"
		;;
	run)
		_gh_run_list "$@"
		;;
	issue)
		_gh_issue_list "$@"
		;;
	repo)
		_gh_repo_list "$@"
		;;
	--help | -h | help | "")
		_show_root_help
		;;
	*)
		gum log --level error "Unknown command '$command'"
		gum log --level info "Available commands: pr, run, issue, repo"
		gum log --level info "Run 'gh fzf --help' for detailed usage information"
		exit 1
		;;
	esac
}

main "$@"
